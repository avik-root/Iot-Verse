{% extends "base.html" %}

{% block title %}IoT Verse - Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.0/nouislider.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    .device-type-badge {
        background-color: #e2e8f0;
        color: #475569;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-block;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .device-type-badge:hover {
        background-color: #cbd5e1;
    }
    
    .filter-tag {
        background-color: #dbeafe;
        color: #1e40af;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.85rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-flex;
        align-items: center;
    }
    
    .filter-tag .close {
        margin-left: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        opacity: 0.7;
    }
    
    .filter-tag .close:hover {
        opacity: 1;
    }
    
    .price-range-values {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 500;
    }
    
    .price-range-values span::before {
        content: "";
        margin-right: 0;
    }
    
    .total-value-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        text-align: center;
    }
    
    .total-value-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .total-value-card h3::before {
        content: "";
        font-size: 1.8rem;
        margin-right: 0;
    }
    
    .total-value-card p {
        opacity: 0.9;
        margin: 0;
    }
    
    .currency-badge {
        background-color: #f0f9ff;
        color: #0369a1;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Currency Indicator -->
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div class="currency-badge">
            <i class="bi bi-currency-rupee"></i> All prices in Indian Rupees
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card search-box">
            <div class="card-body">
                <form action="{{ url_for('search') }}" method="get" class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="q" placeholder="Search IoT devices..." 
                               value="{{ search_query if search_query else '' }}">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="availability">
                            <option value="all">All Status</option>
                            <option value="In Stock" {% if request.args.get('availability') == 'In Stock' %}selected{% endif %}>In Stock</option>
                            <option value="Out of Stock" {% if request.args.get('availability') == 'Out of Stock' %}selected{% endif %}>Out of Stock</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="type">
                            <option value="all">All Types</option>
                            {% for type in types %}
                            {% if type %}
                            <option value="{{ type }}" {% if request.args.get('type') == type %}selected{% endif %}>{{ type }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="col-12 mt-3">
                        <a class="btn btn-link" data-bs-toggle="collapse" href="#advancedFilters">
                            <i class="bi bi-funnel"></i> Advanced Filters
                        </a>
                        <div class="collapse" id="advancedFilters">
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label form-price-label">Price Range</label>
                                    <div id="priceRange"></div>
                                    <div class="price-range-values">
                                        <span>Min: <span id="minPriceValue">0</span></span>
                                        <span>Max: <span id="maxPriceValue">50,000</span></span>
                                    </div>
                                    <input type="hidden" name="min_price" id="minPrice" value="{{ request.args.get('min_price', '0') }}">
                                    <input type="hidden" name="max_price" id="maxPrice" value="{{ request.args.get('max_price', '50000') }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Popular Types</label>
                                    <div class="d-flex flex-wrap">
                                        {% for type in types[:10] %}
                                        {% if type %}
                                        <span class="device-type-badge" onclick="setTypeFilter('{{ type }}')">
                                            {{ type }}
                                        </span>
                                        {% endif %}
                                        {% endfor %}
                                        {% if types|length > 10 %}
                                        <span class="device-type-badge" data-bs-toggle="modal" data-bs-target="#allTypesModal">
                                            +{{ types|length - 10 }} more
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Filters -->
                    {% if request.args.get('q') or request.args.get('availability') != 'all' or request.args.get('type') != 'all' or request.args.get('min_price') or request.args.get('max_price') %}
                    <div class="col-12 mt-3">
                        <small class="text-muted">Active Filters:</small>
                        <div class="d-flex flex-wrap mt-1">
                            {% if request.args.get('q') %}
                            <span class="filter-tag">
                                Search: "{{ request.args.get('q') }}"
                                <span class="close" onclick="removeFilter('q')">&times;</span>
                            </span>
                            {% endif %}
                            {% if request.args.get('availability') and request.args.get('availability') != 'all' %}
                            <span class="filter-tag">
                                Status: {{ request.args.get('availability') }}
                                <span class="close" onclick="removeFilter('availability')">&times;</span>
                            </span>
                            {% endif %}
                            {% if request.args.get('type') and request.args.get('type') != 'all' %}
                            <span class="filter-tag">
                                Type: {{ request.args.get('type') }}
                                <span class="close" onclick="removeFilter('type')">&times;</span>
                            </span>
                            {% endif %}
                            {% if request.args.get('min_price') or request.args.get('max_price') %}
                            <span class="filter-tag">
                                Price: {{ request.args.get('min_price', '0') }} - {{ request.args.get('max_price', '50000') }}
                                <span class="close" onclick="removePriceFilter()">&times;</span>
                            </span>
                            {% endif %}
                            <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-secondary align-self-center">
                                Clear All
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Total Inventory Value -->
{% if products %}
<div class="row mb-4">
    <div class="col-12">
        <div class="total-value-card">
            <h3 class="format-price" id="totalValueDisplay" data-price-inr="{{ total_value }}" data-original-text="{{ "%.2f"|format(total_value) }}">â‚¹{{ "%.2f"|format(total_value) }}</h3>
            <p>Total Inventory Value ({{ products|length }} devices)</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Products Grid -->
<div class="row" id="product-grid">
    {% if products %}
        {% for product in products %}
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="card iot-card h-100">
                <div class="position-relative">
                    <img src="{{ url_for('uploaded_file', filename=product.image) if product.image != 'default.jpg' else url_for('static', filename='images/default-device.gif') }}" 
                         class="card-img-top" 
                         alt="{{ product.name }}"
                         onerror="this.src='{{ url_for('static', filename='images/default-device.gif') }}'">
                    <span class="badge badge-availability {% if product.availability == 'In Stock' %}badge-instock
                        {% elif product.availability == 'Out of Stock' %}badge-outofstock
                        {% else %}bg-secondary{% endif %}">
                        {{ product.availability }}
                    </span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    {% if product.type %}
                    <span class="badge bg-light text-dark mb-2">{{ product.type }}</span>
                    {% endif %}
                    <p class="card-text text-muted" style="font-size: 0.9rem;">
                        {{ product.description[:80] }}{% if product.description|length > 80 %}...{% endif %}
                    </p>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="price-tag format-price" data-price-inr="{{ product.price }}" data-original-text="{{ "%.2f"|format(product.price) }}">{{ "%.2f"|format(product.price) }}</span>
                        <span class="badge bg-secondary">
                            <i class="bi bi-box"></i> {{ product.quantity }} units
                        </span>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <a href="{{ url_for('product_detail', product_id=product.id) }}" 
                       class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-info-circle"></i> View Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-device-ssd display-1 text-muted"></i>
                <h3 class="mt-3">No IoT Devices Found</h3>
                <p class="text-muted">
                    {% if search_query or request.args.get('availability') != 'all' or request.args.get('type') != 'all' or request.args.get('min_price') or request.args.get('max_price') %}
                    No devices match your search criteria. Try changing your filters.
                    {% else %}
                    No devices available. Add some products in the admin panel or upload a CSV file.
                    {% endif %}
                </p>
                <a href="{{ url_for('home') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-clockwise"></i> Clear Filters
                </a>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-success ms-2">
                    <i class="bi bi-plus-circle"></i> Add Products
                </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Stats -->
{% if products %}
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3>{{ products|length }}</h3>
                        <p class="text-muted">Total Devices</p>
                    </div>
                    <div class="col-md-3">
                        <h3>{{ products|selectattr('availability', 'equalto', 'In Stock')|list|length }}</h3>
                        <p class="text-muted">In Stock</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="format-price">{{ "%.2f"|format((products|sum(attribute='price')|float)/products|length if products|length > 0 else 0) }}</h3>
                        <p class="text-muted">Avg Price</p>
                    </div>
                    <div class="col-md-3">
                        <h3>{{ products|sum(attribute='quantity') }}</h3>
                        <p class="text-muted">Total Units</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- All Types Modal -->
<div class="modal fade" id="allTypesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">All Device Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap">
                    {% for type in types %}
                    {% if type %}
                    <span class="device-type-badge mb-2" onclick="setTypeFilter('{{ type }}'); $('#allTypesModal').modal('hide');">
                        {{ type }}
                    </span>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.0/nouislider.min.js"></script>
<script>
function setTypeFilter(type) {
    document.querySelector('select[name="type"]').value = type;
    document.querySelector('form').submit();
}

function removeFilter(filterName) {
    const url = new URL(window.location.href);
    url.searchParams.delete(filterName);
    window.location.href = url.toString();
}

function removePriceFilter() {
    const url = new URL(window.location.href);
    url.searchParams.delete('min_price');
    url.searchParams.delete('max_price');
    window.location.href = url.toString();
}

// Format price with Indian numbering system
function formatIndianNumber(num) {
    if (isNaN(num)) return '0';
    
    num = parseFloat(num);
    if (num >= 10000000) {
        return (num / 10000000).toFixed(1) + ' Cr';
    } else if (num >= 100000) {
        return (num / 100000).toFixed(1) + ' L';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + ' K';
    }
    return num.toLocaleString('en-IN');
}

// Initialize price slider
document.addEventListener('DOMContentLoaded', function() {
    const priceRange = document.getElementById('priceRange');
    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');
    const minPriceValue = document.getElementById('minPriceValue');
    const maxPriceValue = document.getElementById('maxPriceValue');
    
    if (priceRange) {
        const minVal = parseInt(minPrice.value) || 0;
        const maxVal = parseInt(maxPrice.value) || 50000;
        
        noUiSlider.create(priceRange, {
            start: [minVal, maxVal],
            connect: true,
            range: {
                'min': 0,
                'max': 50000
            },
            step: 100,
            format: {
                to: function(value) {
                    return Math.round(value);
                },
                from: function(value) {
                    return Number(value);
                }
            }
        });
        
        priceRange.noUiSlider.on('update', function(values) {
            const min = Math.round(values[0]);
            const max = Math.round(values[1]);
            
            minPrice.value = min;
            maxPrice.value = max;
            minPriceValue.textContent = formatIndianNumber(min);
            maxPriceValue.textContent = formatIndianNumber(max);
        });
    }
    
    // Format all price displays on page
    document.querySelectorAll('.price-tag').forEach(element => {
        const text = element.textContent;
        const price = parseFloat(text.replace(/[^0-9.-]+/g, ''));
        if (!isNaN(price)) {
            element.textContent = price.toLocaleString('en-IN');
        }
    });
    
    // Format total value
    const totalValue = document.querySelector('.total-value-card h3');
    if (totalValue) {
        const text = totalValue.textContent;
        const value = parseFloat(text.replace(/[^0-9.-]+/g, ''));
        if (!isNaN(value)) {
            totalValue.textContent = value.toLocaleString('en-IN');
        }
    }
});
</script>

<!-- Volta Floating Button -->
<div id="voltaFloatingBtn" class="volta-floating-btn" onclick="openVoltaChat()" title="Ask Volta AI">
    <i class="bi bi-robot"></i>
</div>

<!-- Volta Chat Modal -->
<div class="modal fade" id="voltaChatModal" tabindex="-1" aria-labelledby="voltaChatLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="voltaChatLabel">
                    <i class="bi bi-robot"></i> Volta - Your IoT Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="voltaChatContainer" style="height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <div id="chatMessages" style="display: flex; flex-direction: column; gap: 10px;">
                        <div class="alert alert-info" role="alert">
                            <strong>Welcome to Volta!</strong> I'm your IoT assistant. Ask me anything about IoT devices, AI/ML, Cyber Security, and Computer Science.
                        </div>
                    </div>
                    <div id="voltaTyping" style="display: none; text-align: center; padding: 10px;">
                        <span class="spinner-border spinner-border-sm text-info me-2"></span>
                        <small class="text-muted">Volta is thinking...</small>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="voltaInput" placeholder="Ask Volta..." 
                               onkeypress="if(event.key==='Enter') sendVoltaMessage()">
                        <button class="btn btn-info" type="button" onclick="sendVoltaMessage()">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.volta-floating-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 999;
    transition: all 0.3s ease;
    border: none;
}

.volta-floating-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
}

.volta-floating-btn:active {
    transform: scale(0.95);
}

@media (max-width: 768px) {
    .volta-floating-btn {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 24px;
    }
}
</style>

<script>
function openVoltaChat() {
    const modal = new bootstrap.Modal(document.getElementById('voltaChatModal'));
    modal.show();
    // Focus input when modal is shown
    setTimeout(() => document.getElementById('voltaInput').focus(), 500);
}

function sendVoltaMessage() {
    const input = document.getElementById('voltaInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    const chatMessages = document.getElementById('chatMessages');
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'alert alert-primary text-end mb-0';
    userMessageDiv.textContent = message;
    chatMessages.appendChild(userMessageDiv);
    
    input.value = '';
    
    // Show typing indicator
    document.getElementById('voltaTyping').style.display = 'block';
    
    // Scroll to bottom
    const container = document.getElementById('voltaChatContainer');
    setTimeout(() => container.scrollTop = container.scrollHeight, 50);
    
    // Send to API
    fetch('{{ url_for("api_chat") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => Promise.reject(data));
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('voltaTyping').style.display = 'none';
        
        if (data.success && data.response) {
            const responseDiv = document.createElement('div');
            responseDiv.className = 'alert alert-light mb-0 border-start border-info';
            responseDiv.innerHTML = `<strong>Volta:</strong> ${data.response}`;
            chatMessages.appendChild(responseDiv);
        } else if (data.response && !data.success) {
            const responseDiv = document.createElement('div');
            responseDiv.className = 'alert alert-light mb-0 border-start border-info';
            responseDiv.innerHTML = `<strong>Volta:</strong> ${data.response}`;
            chatMessages.appendChild(responseDiv);
        } else if (data.error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mb-0';
            errorDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
            chatMessages.appendChild(errorDiv);
        }
        
        setTimeout(() => container.scrollTop = container.scrollHeight, 50);
    })
    .catch(error => {
        document.getElementById('voltaTyping').style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mb-0';
        const errorMsg = error.error || error.message || 'Unknown error occurred';
        errorDiv.innerHTML = `<strong>Error:</strong> ${errorMsg}`;
        chatMessages.appendChild(errorDiv);
        
        setTimeout(() => container.scrollTop = container.scrollHeight, 50);
    });
}
</script>
{% endblock %}