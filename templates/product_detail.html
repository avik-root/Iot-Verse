{% extends "base.html" %}

{% block title %}{{ product.name }} - IoT Verse{% endblock %}

{% block extra_css %}
<style>
    /* Product Hero Section */
    .product-hero {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-5);
    }

    @media (max-width: 768px) {
        .product-hero {
            grid-template-columns: 1fr;
        }
    }

    .product-image-card {
        overflow: hidden;
    }

    .product-image-card img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        transition: transform var(--transition);
    }

    .product-image-card:hover img {
        transform: scale(1.05);
    }

    /* Product Info */
    .product-title {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: var(--space-3);
    }

    .product-price {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: var(--space-2);
    }

    /* Info Cards */
    .info-card {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--space-4);
        text-align: center;
        transition: all var(--transition);
    }

    .info-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-glow);
    }

    .info-card h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: var(--space-1);
    }

    .info-card p {
        margin: 0;
        font-size: 0.85rem;
    }

    body.dark-mode .info-card {
        background: rgba(129, 140, 248, 0.1);
    }

    body.dark-mode .info-card h5 {
        color: #818cf8;
    }

    /* Average Price Card */
    .avg-price-card {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
        border: 1px solid rgba(6, 182, 212, 0.3);
        border-radius: var(--border-radius);
        padding: var(--space-4);
        text-align: center;
    }

    .avg-price-card h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent);
    }

    body.dark-mode .avg-price-card {
        background: rgba(34, 211, 238, 0.1);
        border-color: rgba(34, 211, 238, 0.3);
    }

    body.dark-mode .avg-price-card h5 {
        color: #22d3ee;
    }

    /* Price History */
    .price-change {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--border-radius-sm);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .price-up {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .price-down {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .price-same {
        background: rgba(100, 116, 139, 0.1);
        color: #64748b;
    }

    body.dark-mode .price-up {
        background: rgba(52, 211, 153, 0.15);
        color: #34d399;
    }

    body.dark-mode .price-down {
        background: rgba(248, 113, 113, 0.15);
        color: #f87171;
    }

    /* Currency Note */
    .currency-note {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<!-- Currency Note -->
<div class="alert alert-info mb-4">
    <i class="bi bi-currency-rupee me-2"></i>All prices are displayed in Indian Rupees (INR)
</div>

<!-- Product Hero Section -->
<div class="product-hero mb-4">
    <!-- Product Image -->
    <div class="card product-image-card">
        <div class="card-body p-0 overflow-hidden">
            <img src="{{ url_for('uploaded_file', filename=product.image) if product.image != 'default.jpg' else url_for('static', filename='images/default-device.gif') }}"
                alt="{{ product.name }}"
                onerror="this.src='{{ url_for('static', filename='images/default-device.gif') }}'">
        </div>
    </div>

    <!-- Product Details -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
                <h1 class="product-title">{{ product.name }}</h1>
                <span class="badge {% if product.availability == 'In Stock' %}badge-instock
                    {% elif product.availability == 'Out of Stock' %}badge-outofstock
                    {% else %}bg-secondary{% endif %}" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                    {{ product.availability }}
                </span>
            </div>

            {% if product.type %}
            <span class="badge bg-light text-dark mb-3" style="font-weight: 500;">{{ product.type }}</span>
            {% endif %}

            <div class="mb-4">
                <div class="product-price" data-price-inr="{{ product.price }}">₹{{ "{:,.2f}".format(product.price) }}
                </div>
                <small class="text-muted">Current Price</small>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="info-card">
                        <h5>{{ product.quantity }}</h5>
                        <p class="text-muted">Quantity Available</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="info-card">
                        <h5 data-price-inr="{{ product.price * product.quantity }}">₹{{ "{:,.0f}".format(product.price *
                            product.quantity) }}</h5>
                        <p class="text-muted">Total Value</p>
                    </div>
                </div>
            </div>

            {% if average_price %}
            <div class="avg-price-card mb-4">
                <h5 data-price-inr="{{ average_price }}">₹{{ "{:,.2f}".format(average_price) }}</h5>
                <small class="text-muted">Average Price (History)</small>
            </div>
            {% endif %}

            <div class="mb-4">
                <h5>Description</h5>
                <p class="text-muted">{{ product.description }}</p>
            </div>

            <div class="mb-4">
                <small class="text-muted">
                    <i class="bi bi-calendar me-1"></i>Last Updated: {{ product.last_updated[:10] }}
                </small>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-warning">
                    <i class="bi bi-pencil-fill"></i> Edit Product
                </a>
                {% endif %}
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#voltaChatModal">
                    <i class="bi bi-robot"></i> Ask Volta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Price History -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-graph-up-arrow me-2"></i>Price History (INR)
    </div>
    <div class="card-body">
        {% if price_graph %}
        <div class="text-center mb-4">
            <img src="{{ price_graph }}" alt="Price History Graph" class="img-fluid rounded" style="max-height: 300px;">
            <p class="currency-note mt-2">Price history shown in INR</p>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-bar-chart-line display-1 text-muted"></i>
            <p class="text-muted mt-3">No price history available</p>
            <small class="text-muted">Price tracking begins when changes occur</small>
        </div>
        {% endif %}

        {% if price_history %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Price (INR)</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody>
                    {% set previous_price = product.price %}
                    {% for history in price_history|reverse %}
                    <tr>
                        <td>{{ history.date[:10] }}</td>
                        <td data-price-inr="{{ history.price }}">₹{{ "{:,.2f}".format(history.price) }}</td>
                        <td>
                            {% if loop.first %}
                            <span class="badge bg-secondary">Current</span>
                            {% else %}
                            {% set change = previous_price - history.price %}
                            <span
                                class="price-change {% if change > 0 %}price-up{% elif change < 0 %}price-down{% else %}price-same{% endif %}">
                                {% if change > 0 %}▲{% elif change < 0 %}▼{% endif %} ₹{{ "%.2f" |format(change|abs) }}
                                    </span>
                                    {% endif %}
                        </td>
                    </tr>
                    {% set previous_price = history.price %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- Back Button -->
<div class="d-flex gap-2 flex-wrap">
    <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Products
    </a>
    {% if current_user.is_authenticated %}
    <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-outline-warning">
        <i class="bi bi-pencil"></i> Edit
    </a>
    {% endif %}
</div>

<!-- Volta Chat Modal -->
<div class="modal fade" id="voltaChatModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--gradient-accent); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-robot me-2"></i>Volta - Ask About {{ product.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="voltaChatContainer"
                    style="height: 400px; overflow-y: auto; background: var(--bg-secondary); border-radius: var(--border-radius); padding: var(--space-4);">
                    <div id="chatMessages" style="display: flex; flex-direction: column; gap: var(--space-3);">
                        <div class="alert alert-info">
                            <strong>Welcome!</strong> Ask me anything about <strong>{{ product.name }}</strong>.
                            <br><small>I specialize in IoT, AI/ML, Cyber Security, and CSE topics.</small>
                        </div>
                    </div>
                    <div id="voltaTyping" style="display: none; text-align: center; padding: var(--space-3);">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <small class="text-muted">Volta is thinking...</small>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="voltaInput" placeholder="Ask Volta..."
                            onkeypress="if(event.key==='Enter') sendVoltaMessage()">
                        <button class="btn btn-info" type="button" onclick="sendVoltaMessage()">
                            <i class="bi bi-send-fill"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function sendVoltaMessage() {
        const input = document.getElementById('voltaInput');
        const message = input.value.trim();

        if (!message) return;

        const chatMessages = document.getElementById('chatMessages');
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'alert alert-primary text-end mb-0';
        userMessageDiv.style.background = 'var(--gradient-primary)';
        userMessageDiv.style.color = 'white';
        userMessageDiv.style.border = 'none';
        userMessageDiv.textContent = message;
        chatMessages.appendChild(userMessageDiv);

        input.value = '';
        document.getElementById('voltaTyping').style.display = 'block';

        const container = document.getElementById('voltaChatContainer');
        setTimeout(() => container.scrollTop = container.scrollHeight, 50);

        fetch('{{ url_for("api_chat") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `[About {{ product.name }}] ${message}` })
        })
            .then(response => response.ok ? response.json() : response.json().then(data => Promise.reject(data)))
            .then(data => {
                document.getElementById('voltaTyping').style.display = 'none';

                if (data.response) {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'alert alert-light mb-0';
                    responseDiv.style.borderLeft = '4px solid var(--accent)';
                    responseDiv.innerHTML = `<strong style="color: var(--accent);">Volta:</strong> ${data.response}`;
                    chatMessages.appendChild(responseDiv);
                } else if (data.error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger mb-0';
                    errorDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
                    chatMessages.appendChild(errorDiv);
                }

                setTimeout(() => container.scrollTop = container.scrollHeight, 50);
            })
            .catch(error => {
                document.getElementById('voltaTyping').style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mb-0';
                errorDiv.innerHTML = `<strong>Error:</strong> ${error.error || error.message || 'Unknown error'}`;
                chatMessages.appendChild(errorDiv);
                setTimeout(() => container.scrollTop = container.scrollHeight, 50);
            });
    }
</script>
{% endblock %}